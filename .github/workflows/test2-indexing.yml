name: Test Google Indexing API

on:
  workflow_dispatch:
    inputs:
      url:
        description: "URL to test indexing"
        required: true
        default: "https://aymansalem.github.io/"

permissions:
  contents: read

jobs:
  test-indexing:
    runs-on: ubuntu-latest

    steps:
      - name: Save Google JSON secret
        run: |
          if [ -z "${{ secrets.GOOGLE_JSON }}" ]; then
            echo "âŒ GOOGLE_JSON secret is empty!"
            exit 1
          fi
          echo "${{ secrets.GOOGLE_JSON }}" > /tmp/google_key.json
          # Check JSON validity
          if ! jq empty /tmp/google_key.json 2>/dev/null; then
            echo "âŒ GOOGLE_JSON is not valid JSON."
            echo "ðŸ‘‰ Please copy the exact contents of your Google service account .json file into the GitHub secret."
            exit 1
          fi

      - name: Install Google API Client
        run: python3 -m pip install --upgrade --quiet google-api-python-client google-auth

      - name: Run Test Indexing Request
        run: |
          cat > test_indexing.py << 'EOF'
          import sys
          from google.oauth2 import service_account
          from googleapiclient.discovery import build

          creds_file = "/tmp/google_key.json"
          SCOPES = ["https://www.googleapis.com/auth/indexing"]

          url_to_test = "${{ github.event.inputs.url }}"

          try:
              creds = service_account.Credentials.from_service_account_file(creds_file, scopes=SCOPES)
              service = build("indexing", "v3", credentials=creds, cache_discovery=False)
          except Exception as e:
              print("âŒ Failed to initialize Google API client:", e)
              sys.exit(1)

          try:
              response = service.urlNotifications().publish(body={"url": url_to_test, "type": "URL_UPDATED"}).execute()
              print(f"âœ… Google indexing updated for: {url_to_test}")
              print(response)
          except Exception as e:
              print(f"âŒ Google API error for {url_to_test}: {e}")
          EOF

          python3 test_indexing.py
